<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙƒØ±ØªØ§Ø±ÙŠØ© - Ù†Ø¸Ø§Ù… Ù†Ø¨Ø¶</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; }
        body { font-family: 'Cairo', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f8f9fa; color: var(--primary); }
        .emergency-row { background-color: #fff5f5 !important; border-right: 5px solid var(--danger); }
        .note-text { color: #d63031; font-weight: bold; font-size: 12px; background: #fff5f5; padding: 3px; border-radius: 4px; display: block; margin-top: 5px; }
        .btn { padding: 8px 12px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; transition: 0.3s; }
        .btn-status { background: var(--accent); color: white; }
        .btn-toggle { background: #34495e; color: white; margin-right: 10px; }
        input, select { padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Cairo'; }
    </style>
</head>
<body>

<div id="auth-screen" class="card" style="max-width:350px; margin: 100px auto; text-align:center;">
    <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³ÙƒØ±ØªØ§Ø±ÙŠØ© ğŸ“‹</h2>
    <input type="text" id="login-doc-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ±" style="width:90%; margin:10px 0;">
    <input type="password" id="login-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:90%; margin:10px 0;">
    <button class="btn btn-status" style="width:100%" onclick="authenticate()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="main-dashboard" style="display:none;">
    <div class="card" style="background:var(--primary); color:white; display:flex; justify-content:space-between; align-items:center;">
        <h2 id="display-name" style="margin:0;">Ø¯. </h2>
        <div>
            <button class="btn btn-toggle" id="toggle-btn" onclick="toggleBooking()">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ø¬Ø²</button>
            <button class="btn" style="background:#95a5a6; color:white;" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div class="card">
        <h4>ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø±Ø¶Ù‰:</h4>
        <input type="date" id="new-available-date">
        <button class="btn btn-status" onclick="addAvailableDate()">Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ®</button>
        <div id="available-dates-list" style="margin-top:10px;"></div>
    </div>

    <div class="card" style="display:flex; align-items:center; gap:15px;">
        <label>Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙŠÙˆÙ…:</label>
        <input type="date" id="filter-date" onchange="loadAppointments()">
        <button class="btn" style="background:#bdc3c7;" onclick="resetDay()">ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø±Ù‚Ù…</th>
                <th>Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                <th>Ø§Ù„Ø¹Ù…Ø± / Ø§Ù„Ø³ÙƒÙ†</th>
                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
        </thead>
        <tbody id="patient-list"></tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    const config = { apiKey: "AIzaSyBzanPVbS8RWulSgQnnV-QJSTrnVbLX8Tw", databaseURL: "https://nabid-app-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(config);
    const db = firebase.database();
    let activeDoc = "";
    document.getElementById('filter-date').valueAsDate = new Date();

    function authenticate() {
        const name = document.getElementById('login-doc-name').value.trim();
        const pass = document.getElementById('login-pass').value.trim();
        db.ref('hospital/settings/doctors/' + name).once('value', s => {
            const data = s.val();
            if(data && data.password === pass) {
                activeDoc = name;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                document.getElementById('display-name').innerText = "Ø¯. " + name;
                syncAvailableDates();
                syncBookingStatus();
                loadAppointments();
            } else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        });
    }

    function syncAvailableDates() {
        db.ref('hospital/settings/doctors/' + activeDoc + '/availableDates').on('value', s => {
            const list = document.getElementById('available-dates-list');
            list.innerHTML = "";
            const dates = s.val() || {};
            for(let d in dates) list.innerHTML += `<span style="background:#eefaff; padding:8px; margin:5px; border-radius:8px; display:inline-block; border:1px solid #accent;">${d} <b style="color:red; cursor:pointer; margin-right:5px;" onclick="removeDate('${d}')">âœ•</b></span> `;
        });
    }

    function addAvailableDate() {
        const d = document.getElementById('new-available-date').value;
        if(d) db.ref('hospital/settings/doctors/' + activeDoc + '/availableDates').child(d).set(true);
    }

    function removeDate(d) { db.ref('hospital/settings/doctors/' + activeDoc + '/availableDates').child(d).remove(); }

    function syncBookingStatus() {
        db.ref('hospital/settings/doctors/' + activeDoc + '/bookingStatus').on('value', s => {
            const status = s.val() || 'open';
            const btn = document.getElementById('toggle-btn');
            btn.innerText = (status === 'open') ? "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ø¬Ø²" : "ÙØªØ­ Ø§Ù„Ø­Ø¬Ø²";
            btn.style.background = (status === 'open') ? "#34495e" : "#27ae60";
        });
    }

    function toggleBooking() {
        db.ref('hospital/settings/doctors/' + activeDoc + '/bookingStatus').once('value', s => {
            const current = s.val() || 'open';
            db.ref('hospital/settings/doctors/' + activeDoc).update({bookingStatus: current === 'open' ? 'closed' : 'open'});
        });
    }

    function loadAppointments() {
        const selDate = document.getElementById('filter-date').value;
        db.ref('hospital/doctors/' + activeDoc).on('value', s => {
            const data = s.val() || {};
            const apps = data.appointments || {};
            const curr = data.currentNumber || 0;
            const list = document.getElementById('patient-list');
            list.innerHTML = "";
            for(let id in apps) {
                if(apps[id].date === selDate) {
                    list.innerHTML += `
                        <tr class="${apps[id].isEmergency ? 'emergency-row' : ''}">
                            <td>${id}</td>
                            <td><b>${apps[id].name}</b></td>
                            <td>${apps[id].age || '--'} Ø³Ù†Ø© / ${apps[id].address || '--'}</td>
                            <td>${apps[id].phone}</td>
                            <td>
                                ${id == curr ? '<b style="color:green">â— Ø¨Ø§Ù„Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¢Ù†</b>' : (id < curr ? 'âœ“ Ø§Ù†ØªÙ‡Ù‰' : 'ğŸ•’ ÙŠÙ†ØªØ¸Ø±')}
                                ${apps[id].doctorNote ? `<span class="note-text">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨: ${apps[id].doctorNote}</span>` : ''}
                            </td>
                            <td><button class="btn" style="background:#e74c3c; color:white;" onclick="setEmergency('${id}')">ğŸš¨ Ø·Ø§Ø±Ø¦</button></td>
                        </tr>`;
                }
            }
        });
    }

    function setEmergency(id) { db.ref('hospital/doctors/' + activeDoc + '/appointments/' + id).update({isEmergency:true}); }
    function resetDay() { if(confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø­Ø¬ÙˆØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) db.ref('hospital/doctors/' + activeDoc).update({currentNumber:0, lastIssuedNumber:0, appointments:{}}); }
</script>
</body>
</html>